# api/server.py

"""Вопросы:


1. в заявках отдаем qty дробным, хотя Astras ждет int32
2. bids[].volume и asks[].volume отдаются float, Astras ждет int64
3. volume, ask_vol, bid_vol в котировках может быть дробный, астрас ждет int64 (в базовой валюте)
4. open_price в котировках нет, можно сделать pen24h в tickers (цена 24h назад)
5. total_bid_vol, total_ask_vol пока 0. Строго можно посчитать сумму объёмов по тем уровням стакана, которые реально получаешь (например, depth=10/20/50). Это будет “сумма по полученной глубине”, а не “по всему стакану”, потому что полный стакан OKX не отдаёт. Если Astras ожидает именно “по всем уровням”, тогда строго это невозможно и надо ставить 0. 
Если допускается “по стакану, который вы получаете по подписке” (как в OrderBookGetAndSubscribe), тогда считаем сумму по полученным уровням.
6.  отдается за 24 часа "high_price": high_price, "low_price": low_price
7. qtyUnits в сделках по портфелю вместо int отдается float
8. все заявки/сделки по портфелю отдают все заявки/сделки по аккаунту, так как в okx нет портфелей. внутри аккаунта можно различать типы счетов (instType: SPOT / SWAP / FUTURES / OPTION)
9. реализовываем только SPOT. FUTURES и SWAP можно добавить позже
10. OKX рекомендует использовать For other users, please use WS / Order channel
- к private WebSocket-каналу `fills` (исполнения/сделки) подписка разрешена только для аккаунтов с trading fee tier VIP6+ (ошибка `code=60029`).
- На обычных аккаунтах real-time сделки через `fills` недоступны; для проверки/получения сделок используйте приватный REST (fills-history) либо private WS канал `orders`, где могут приходить события об исполнениях.
11. соощение об ошибке в httpcode передаем реальный код okx


1. нужно ли делать возмоность множественных одинаковых подписок?
2. 389, 474, 453, 122, 447, 400, 429 строка - костыль (устарели номера строк)
3. ошибки таймаута сами придумали
4. документация для карты рынка
5. размер и структура файлов

0. пинг у нас - загрушка. в okx пинга нет
1. сейчас открытие=закрытие=open24h - скользящее окно 24 часа назад. можно использовать sodUtc0 - open дня по UTC0
при этом low_price high_price можно только за сутки
2. заявки (пока рыночная): SPOT: размер в базовой валюте (sz = amount_base). FUTURES/SWAP: размер в контрактах (sz = number_of_contracts)
quantity у нас может быть float (в доках int)
3. лимитная заявка пока без айсбергов
4. oneday лимитных заявок нет. ставится обычная limit как goodtillcancelled
attheclose - отклоняется, так как нет закрытия торгов. 
5. стоп-заявка реализована как условная. okx сама хранит заявку
"""

1. если на аккаунте уже есть isolated-позиции (вне вашего потока), details[].imr их не отражает полностью. для initialMargin в блоттере